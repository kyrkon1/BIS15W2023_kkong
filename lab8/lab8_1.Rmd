---
title: "Tidyr 1: Tidy data and `pivot_long()`"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: spacelab
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

> **For Big-Data Scientists, "Janitor Work" Is Key Hurdle to Insights.**  
> "Data scientists, according to interviews and expert estimates, spend from 50 percent to 80 percent of their time mired in the mundane labor of collecting and preparing data, before it can be explored for useful information."  
> [New York Times (2014)](http://www.nytimes.com/2014/08/18/technology/for-big-data-scientists-hurdle-to-insights-is-janitor-work.html)

## Learning Goals
*At the end of this exercise, you will be able to:*    
1. Explain the difference between tidy and messy data.  
2. Evaluate a data set as tidy or messy.    
3. Use the `pivot_longer()` function of `tidyr` to transform data from wide to long format.  
4. Use `separate()` to split observations within a column.  

## Overview
The quote above sums up much of the work in data science. Simply put, most of the data that you end up working with will be messy, disorganized, and not **tidy**. By the end of this week, you will have the tools necessary to wrangle messy data into tidy data that are ready for analysis. I know that we have spent a lot of time of data transformation, but this last step is essential to building plots and performing other analyses.   

## Resources  
- [tidyr `pivot_longer()`](https://tidyr.tidyverse.org/reference/pivot_longer.html)  
- [pivoting](https://cran.r-project.org/web/packages/tidyr/vignettes/pivot.html)  

## Load the tidyverse
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
```

## Tidy data
Most "wild" data that you will encounter are organized incorrectly for work in R and, as you might expect, the tools used to transform data are a core part of the tidyverse. I will attempt to summarize the most important points below, but you should read [chapter 12 of the data science text](https://r4ds.had.co.nz/tidy-data.html) for a more thorough explanation.  

`Tidy` data in the sense of the tidyverse follows three conventions:   
(1) each variable has its own column  
(2) each observation has its own row  
(3) each value has its own cell  

This is summarized in the image below. The package used to tidy data is called **tidyr** and is a core part of the tidyverse.  
![*Tidy Data.*](tidy-1.png)

## `pivot_longer()`  
Scientists frequently use spreadsheets that are organized to make data entry efficient. This is often referred to as **wide format**. Unfortunately, the wide format creates a problem because column names may actually represent values of a variable. The command `pivot_longer()` shifts data from wide to long format.   

Rules:  
+ `pivot_longer`(cols, names_to, values_to)
+ `cols` - Columns to pivot to longer format
+ `names_to` - Name of the new column; it will contain the column names of gathered columns as values
+ `values_to` - Name of the new column; it will contain the data stored in the values of gathered columns

## Example 1: column names are data
The following data show results from a drug trial with four treatments on six patients. The values represent resting heart rate.  
```{r}
heartrate <- read_csv("data/heartrate.csv")
heartrate
```

Want to try the `here` package(https://here.r-lib.org/index.html)? I have found that many new R users have difficulty managing directories and accessing files. The `here` package makes this a bit more intuitive.
```{r}
setwd("~/Desktop/BIS15W2023_kkong-main")
getwd()
```

```{r}
here() # running here (puts you in the main working directory, or where you opened the lab folder)
```

```{r}
heartrate <- read_csv(here( "data2", "heartrate.csv")) # to load the data can use here, if you have a project with lot of folders and have its own folder, do not have to reset the working directory everytime, can use here
```

```{r}
heartrate
```

Let's assess whether or not these data are tidy.  
(1) each variable has its own column?  
no? different drugs are actually data
(2) each observation has its own row?  
yes
(3) each value has its own cell?  
yes 
To fix this problem, we need to reshape the table to long format while keeping track of column names and values. We do this using `pivot_longer()`. Notice that the dimensions of the data frame change.  
Shifted data to long, so one patient appears 4 different times
```{r}
heartrate %>%
  pivot_longer(-patient, # patient not pivot
               names_to= "drug", # new column
               values_to = "heartrate" # values are moved
               )
```
(data format to make plots in R, plotting on thursday, does not work on wide data but only on tidydata
## Practice
1. Import the file `relig_income.csv` and store it as a new object `relig_income`.  
```{r}
relig_income <-read_csv(here("data", "relig_income.csv"))
relig_income
```

2. Why are these data untidy?  
range of income should be part of the data set, variable names are data too
col names are data and need to be put in their own column
3. Use `pivot_longer()` to make the data tidy.  
```{r}
relig_income %>% 
  pivot_longer(-religion, 
               names_to ="income",
               values_to = "n_total") 
```

## Example 2: some column names are data
Some (but not all) of the column names are data. We also have NA's.
```{r}
billboard <- readr::read_csv("data/billboard.csv")
billboard
```
# not tidy since the weeks are the data too 
Solution 1: specify a range of columns that you want to pivot.
```{r}
billboard2 <- 
  billboard %>% 
  pivot_longer(wk1:wk76, # a range of columns
               names_to = "week",
               values_to = "rank",
               values_drop_na = TRUE #this will drop the NA's
               )
billboard2
```

Solution 2: OR, specify columns that you want to stay fixed.
```{r}
billboard3 <- 
  billboard %>% 
  pivot_longer(-c(artist, track, date.entered), #specific columns
               names_to = "week",
               values_to = "rank",
               values_drop_na = TRUE
               )
billboard3
```

Solution 3: identify columns by a prefix, remove the prefix and all NA's.
```{r}
billboard %>% 
   pivot_longer(
   cols = starts_with("wk"),
   names_to = "week",
   names_prefix = "wk",
   values_to = "rank",
   values_drop_na = TRUE)
```

## Practice  
1. Import `plant_data.csv` as a new object `plant_data`.  
```{r}
plant_data <- read_csv(here("data","plant_data.csv"))
plant_data
```

2. Why are these data not tidy?  

The columns for day are data too

3. Use `pivot_longer()` to make the data tidy. Focus the data only on genotype, day, and measurement.  
```{r}
plant_data %>% 
  pivot_longer(-c(genotype, water_sched_prog, greenhouse), # columns to keep
               names_to = "v1",
               values_to ="stem_length_cm",
               values_drop_na = TRUE) # removal of NAs
```
#easy to record data wide for analysis in long (for graphing)
## Example 3: more than one variable in a column name
In this case, there are two observations in each column name.
```{r}
qpcr_untidy <- read_csv("data/qpcr_untidy.csv")
qpcr_untidy
```
2 variable names, experiment 1 and replicate 1, and so forth
`names_sep` helps pull these apart, but we still have "exp" and "rep" to deal with.  
```{r}
qpcr_untidy %>% 
  pivot_longer(
    exp1_rep1:exp3_rep3,
    names_to= c("experiment", "replicate"),
    names_sep="_",
    values_to="mRNA_expression"
  )
```

## Example 4: more than one value or observation in a row
This is often caused by an entry error, but R will not be able to work with it unless the values are separated. This doesn't use `pivot_longer()` but is a common problem.  
```{r}
length_data <- readr::read_csv("data/length_data.csv")
length_data
```

```{r}
length_data %>% 
  transform(length = str_split(length, ";")) %>%
  unnest(length)
```

## That's it! Let's take a break and then move on to part 2!  

-->[Home](https://jmledford3115.github.io/datascibiol/)